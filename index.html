<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Connect SFTP — Keys & Secure Variable Setup</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-50 text-gray-800 antialiased">
  <header class="bg-sky-700 text-white shadow">
    <div class="max-w-6xl mx-auto px-4 py-6">
      <h1 class="text-2xl font-semibold tracking-wide">Connect SFTP — Keys & Secure Variable Setup</h1>
      <p class="text-sm text-sky-100 mt-1">
        Generate an SFTP keypair (RSA or ECDSA), share the <em>public</em> key with the vendor/server,
        and use the <strong>private</strong> key securely in Connect.
      </p>
    </div>
  </header>

  <main class="max-w-3xl mx-auto px-4 py-10 space-y-14">

    <!-- Overview -->
    <section class="space-y-3">
      <h2 class="text-xl font-semibold text-sky-700">Overview</h2>
      <ul class="list-disc list-inside text-sm space-y-1">
        <li><strong>Default that works with most vendors:</strong> <code>RSA</code> keypair (Connect signs as <code>ssh-rsa</code>, i.e., SHA-1).</li>
        <li><strong>If the vendor rejects <code>ssh-rsa</code>:</strong> use <code>ECDSA P-256</code> (PEM). This avoids servers that disable SHA-1.</li>
        <li>You will: generate a keypair → send the <em>.pub</em> to the vendor (or install on your SFTP server) → paste the private key into a secure variable in Connect → reference it in <code>defineRemoteFilesystem</code>.</li>
      </ul>
    </section>

    <!-- Prereqs -->
    <section class="space-y-3">
      <h2 class="text-xl font-semibold text-sky-700">Prerequisites</h2>
      <ul class="list-disc list-inside text-sm space-y-1">
        <li><strong>OpenSSH</strong> is built into macOS, Linux, and Windows 10/11. Verify with <code>ssh -V</code>.</li>
        <li>Have the <strong>SFTP username</strong> from your vendor. You’ll include it in the key comment so they can associate the key.</li>
      </ul>
    </section>

    <!-- Generate RSA -->
    <section id="gen-rsa" class="space-y-4">
      <h2 class="text-xl font-semibold text-sky-700">1) Generate an RSA keypair (works with most vendors)</h2>
      <p class="text-sm">Run in macOS Terminal, Linux shell, or Windows PowerShell. Replace <code>your_sftp_username</code> with the vendor-provided username.</p>
      <pre class="bg-gray-100 p-3 rounded text-sm whitespace-pre-wrap"><code># RSA (PEM). 3072-bit recommended; use 2048 if your vendor requires it.
ssh-keygen -t rsa -b 3072 -m PEM -f ./vendor_sftp_rsa -C "your_sftp_username@vendor"</code></pre>
      <ul class="list-disc list-inside text-sm space-y-1">
        <li>Creates <code>vendor_sftp_rsa</code> (private) and <code>vendor_sftp_rsa.pub</code> (public).</li>
        <li>Connect will authenticate with <code>ssh-rsa</code> (SHA-1). If the vendor has disabled <code>ssh-rsa</code>, use the ECDSA method below.</li>
      </ul>
    </section>

    <!-- Generate ECDSA -->
    <section id="gen-ecdsa" class="space-y-4">
      <h2 class="text-xl font-semibold text-sky-700">2) Generate an ECDSA (P-256, PEM) keypair — use if RSA is refused</h2>
      <p class="text-sm">Run in macOS Terminal, Linux shell, or Windows PowerShell.</p>
      <pre class="bg-gray-100 p-3 rounded text-sm whitespace-pre-wrap"><code># ECDSA P-256 (PEM). Works with vendors that reject ssh-rsa/SHA-1.
ssh-keygen -t ecdsa -b 256 -m PEM -f ./vendor_sftp_ecdsa -C "your_sftp_username@vendor"</code></pre>
      <ul class="list-disc list-inside text-sm space-y-1">
        <li>Creates <code>vendor_sftp_ecdsa</code> (private) and <code>vendor_sftp_ecdsa.pub</code> (public).</li>
        <li>Use this when you see errors like <code>userauth_pubkey: key type ssh-rsa not in PubkeyAcceptedAlgorithms</code> or <code>Auth fail</code> with RSA.</li>
      </ul>
    </section>

    <!-- Send public key -->
    <section id="send-pub" class="space-y-4">
      <h2 class="text-xl font-semibold text-sky-700">3) Provide the <em>public</em> key to the SFTP server</h2>
      <div class="space-y-2 text-sm">
        <p><strong>If a vendor hosts the SFTP:</strong> send them the contents of your <code>.pub</code> file (a single line beginning with <code>ssh-rsa</code> or <code>ecdsa-sha2-nistp256</code>). Do <em>not</em> send the private key.</p>
        <p><strong>If you host the SFTP:</strong> append the public key to the account’s <code>~/.ssh/authorized_keys</code> and set permissions:</p>
        <pre class="bg-gray-100 p-3 rounded text-sm whitespace-pre-wrap"><code>mkdir -p ~/.ssh
chmod 700 ~/.ssh
# Use the .pub you generated (RSA or ECDSA)
cat vendor_sftp_rsa.pub &gt;&gt; ~/.ssh/authorized_keys
# or:
# cat vendor_sftp_ecdsa.pub &gt;&gt; ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys</code></pre>
      </div>
    </section>

    <!-- Create privateKey variable -->
    <section id="create-variable" class="space-y-4">
      <h2 class="text-xl font-semibold text-sky-700">4) Create the <code>privateKey</code> variable in Connect (secure)</h2>
      <p class="text-sm">Add a <strong>setVariable</strong> action named <code>privateKey</code>. Open your private key file and paste the <em>entire</em> PEM including the header/footer lines.</p>
      <ul class="list-disc list-inside text-sm space-y-1">
        <li>RSA must start with <code>-----BEGIN RSA PRIVATE KEY-----</code>; ECDSA must start with <code>-----BEGIN EC PRIVATE KEY-----</code>.</li>
        <li><strong>Set the value type to <em>Password</em></strong> so the key is hidden (not stored or shown in plain text).</li>
        <li>Preserve line breaks exactly.</li>
      </ul>
      <img src="img1.png" alt="Create privateKey variable" class="rounded shadow">
      <img src="img3.png" alt="privateKey stored as Password" class="rounded shadow mt-4">
    </section>

    <!-- Reference in defineRemoteFilesystem -->
    <section id="reference-key" class="space-y-4">
      <h2 class="text-xl font-semibold text-sky-700">5) Use the key in <code>defineRemoteFilesystem</code></h2>
      <p class="text-sm">
        Set the host, the <strong>user</strong> (the vendor’s SFTP username), and basePath. Reference the key via <code>extraProperties</code>:
      </p>
      <pre class="bg-gray-100 p-3 rounded text-sm whitespace-pre-wrap"><code>{
  "sftp.privateKey": privateKey
  /* If your private key has a passphrase, also include:
     "sftp.privateKeyPassphrase": privateKeyPass   // another Password variable
  */
}</code></pre>
      <img src="img2.png" alt="extraProperties with sftp.privateKey mapped to privateKey variable" class="rounded shadow">
    </section>

    <!-- Test -->
    <section id="test" class="space-y-3">
      <h2 class="text-xl font-semibold text-sky-700">6) Test the connection</h2>
      <ul class="list-disc list-inside text-sm space-y-1">
        <li>Run the action set and call <code>listFiles</code> (or another simple operation) against the base path.</li>
        <li>If it fails, confirm: host, username, basePath, and that the vendor installed your <code>.pub</code> for that exact username.</li>
      </ul>
    </section>

    <!-- Troubleshooting -->
    <section id="troubleshooting" class="space-y-3">
      <h2 class="text-xl font-semibold text-sky-700">Troubleshooting</h2>
      <ul class="list-disc list-inside text-sm space-y-2">
        <li><strong>“userauth_pubkey: key type ssh-rsa not in PubkeyAcceptedAlgorithms”</strong> — The server disabled <code>ssh-rsa</code> (SHA-1). Generate and use an <strong>ECDSA P-256 (PEM)</strong> key instead.</li>
        <li><strong>“Auth fail”</strong> — The public key likely isn’t installed for that username on the server. Re-send the <code>.pub</code> to the vendor or add it to <code>authorized_keys</code>.</li>
        <li><strong>Key format errors</strong> — Regenerate with the commands above (note <code>-m PEM</code>) and paste the PEM exactly, including headers/footers.</li>
        <li><strong>Passphrase prompts</strong> — Store the passphrase in a Password variable and include <code>"sftp.privateKeyPassphrase"</code> in <code>extraProperties</code>.</li>
      </ul>
    </section>

    <!-- Security -->
    <section id="security" class="space-y-3">
      <h2 class="text-xl font-semibold text-sky-700">Security Notes</h2>
      <ul class="list-disc list-inside text-sm space-y-1">
        <li>Never email your private key. Only share the <code>.pub</code> with the vendor.</li>
        <li>Keep the Connect variable type as <strong>Password</strong> so the key remains hidden in UI and logs.</li>
      </ul>
    </section>

  </main>

  <footer class="bg-sky-700 text-white text-sm">
    <div class="max-w-6xl mx-auto px-4 py-4 text-center">
      © tm-LBenson
    </div>
  </footer>
</body>
</html>
